#!/usr/bin/env bash

# Ambil argumen dari bspwm
wid=$1
class=$2
instance=$3
# Dapatkan title window secara aman
title=$(xprop -id "$wid" _NET_WM_NAME 2> /dev/null | grep -oP '"\K[^"]+(?=")')

# --- DEFINISI GEOMETRI (Ubah di sini agar konsisten) ---
# Format: WxH+X+Y
RECT_MAIN="1435x1020+3+30"        # Layar utama besar
RECT_SIDE_TALL="470x1020+1445+30" # Panel samping tinggi (Chat/Visual)
RECT_SIDE_MED="470x665+1445+385"  # Panel samping medium (AI Chat)
RECT_SIDE_SMALL="470x350+1445+30" # Panel samping kecil (Pinned)
RECT_CENTER_MED="750x665+3+385"   # Tengah medium (TerminalDefault)
RECT_CENTER_SMALL="750x350+3+30"  # Tengah kecil (RMPC)
RECT_YAZI="900x442+0+0"           # Yazi center
# Debugging (Opsional: uncomment untuk melihat nama instance yang asli)
# echo "c=$class | i=$instance | t=$title" >> /tmp/bspwm_debug.log

# --- LOGIC RULES ---
case "$class" in
    "Code" | "code-oss")
        case "$title" in
            *"Chat"* | *"Visual"*)
                echo "state=floating rectangle=$RECT_SIDE_TALL"
                ;;
            *".Chromium")
                echo "state=floating rectangle=$RECT_MAIN"
                ;;
        esac
        ;;

    # Tangkap semua varian browser Chromium
    "ChatAi" | "GeminiAi" | "ClaudeAi" | "youtube" | "reddit")

        # Cek INSTANCE ($3) - Ini biasanya nama domain dari flag --app
        case "$instance" in
            # Youtube & Reddit (Mode Desktop Lebar)
            *"youtube.com"* | *"reddit.com"*)
                echo "desktop=^3 state=floating sticky=off rectangle=$RECT_MAIN"
                ;;

            # AI Chat (Mode Panel Samping)
            *"gemini.google.com"* | *"claude.ai"* | *"chat.openai.com"*)
                echo "state=floating rectangle=$RECT_SIDE_MED"
                ;;

            # Fallback pakai Title jika Instance gagal/aneh
            *)
                case "$title" in
                    *"ChatGPT"* | *"Claude"*)
                        echo "state=floating rectangle=$RECT_SIDE_MED"
                        ;;
                    *"YouTube"* | *"reddit"*)
                        echo "desktop=^3 state=floating sticky=off rectangle=$RECT_MAIN"
                        ;;
                esac
                ;;
        esac
        ;;

    "floating_rmpc")
        echo "state=floating rectangle=$RECT_CENTER_SMALL"
        ;;

    # Case khusus title check jika class rmpc tidak spesifik
    *)
        if [[ "$title" == *"rmpc"* ]]; then
            echo "state=floating rectangle=$RECT_CENTER_SMALL"
            exit 0
        fi
        ;;
esac

# Rules yang murni berdasarkan Class (tanpa cek title yang rumit)
case "$class" in
    "TerminalDefault")
        echo "state=floating sticky=off rectangle=$RECT_CENTER_MED"
        ;;
    "TerminalPinned")
        echo "state=floating sticky=on rectangle=$RECT_SIDE_SMALL"
        ;;
    "St")
        echo "state=floating sticky=off rectangle=$RECT_MAIN"
        ;;
    "TerminalNvim" | "dev.zed.Zed")
        echo "desktop=^3 state=floating sticky=off rectangle=$RECT_MAIN"
        ;;
    "YaziTerm")
        echo "state=floating center=on rectangle=$RECT_YAZI"
        ;;
    "Thunar")
        echo "desktop=^1"
        ;;
    "qView")
        echo "state=floating center=on sticky=off rectangle=470x350+0+0"
        ;;
    "Spotify")
        echo "desktop=^4"
        ;;
    "vesktop")
        echo "desktop=^5"
        ;;
    "Vivaldi-stable")
        echo "desktop=^2"
        ;;
    "emulator")
        echo "state=floating center=on"
        ;;
    "mpv")
        echo "state=floating center=on"
        ;;
esac

# Cek title tambahan untuk aplikasi umum yang mungkin terlewat
case "$title" in
    *"yazi"*)
        echo "state=floating center=on rectangle=$RECT_YAZI"
        ;;
    *"Thunar"*)
        echo "desktop=^1"
        ;;
esac
